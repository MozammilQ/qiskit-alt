FROM qiskit_alt

# May want to try this in order to get conda init to work
SHELL ["/bin/bash", "--login", "-c"]

# cmake is for pyscf
RUN dnf install -y wget passwd cmake fish
# Install miniconda
ENV CONDA_DIR /opt/conda
RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh && \
     /bin/bash ~/miniconda.sh -b -p /opt/conda

# Put conda in path so we can use conda activate
ENV PATH=$CONDA_DIR/bin:$PATH

RUN useradd --create-home --shell /bin/bash someuser
RUN echo "someuser:someuser" | chpasswd

# There are a few lines commented out below that are meant to enable juliaup.
# I was unable to jump through all of the hoops. But, eventually, we should
# be able to uncomment these.
#
# Possibly a redhat bug. I googled this. It is a common problem.
# Did not find a good solution. I did this myself.
# The juliaup_installer.sh needs this print mesg
# But, even after fixing that, it fails.
# RUN chmod o+rw /dev/pts/0
RUN conda init bash
RUN conda init fish
RUN conda config --set auto_activate_base false

USER someuser
WORKDIR /home/someuser

# This needed a second time
ENV CONDA_DIR /opt/conda
ENV PATH=$CONDA_DIR/bin:$PATH

RUN printf "y\n" |  conda create -n qiskit_alt_env python=3.9
RUN conda init bash
RUN conda init fish
RUN conda config --set auto_activate_base false

# Switch back
USER root
WORKDIR /qiskit_alt

# The instructions say to pipe this to sh. But, this wastes time while debugging
# RUN curl -fsSL https://install.julialang.org > juliaup_installer.sh

# Furthermore, this script downloads the real installer, wasting even more time while
# debugging. If you echo $_url in juliaup_installer.sh, you find the following is actually
# the installer. Then try to echo newlines to the real installer and it will say it does
# not support reading from stdin. So we are kind of blocked.
# RUN wget https://julialang-s3.julialang.org/juliaup/bin/juliainstaller-1.5.38-x86_64-unknown-linux-gnu
